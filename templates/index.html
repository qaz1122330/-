<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ä¸šä»ªè¡¨ç›˜æ™ºèƒ½è¯»æ•°ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4/dist/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(90deg, #2c3e50, #4a6491);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 { 
            font-size: 2.5rem; 
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .header p { 
            opacity: 0.9; 
            font-size: 1.1rem;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .status-running { background: #10b981; color: white; }
        .status-warning { background: #f59e0b; color: white; }
        .status-danger { background: #ef4444; color: white; }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }
        
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .video-section, .data-section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .section-title {
            font-size: 1.5rem;
            color: #374151;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .video-container {
            width: 100%;
            height: 400px;
            background: #1f2937;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
            position: relative;
        }
        
        #video-feed {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .control-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(90deg, #4f46e5, #7c3aed);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 70, 229, 0.4);
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .meters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .meter-card {
            background: #f9fafb;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #3b82f6;
        }
        
        .meter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .meter-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #374151;
        }
        
        .meter-value {
            font-size: 2rem;
            font-weight: 700;
            text-align: center;
            margin: 15px 0;
            color: #1f2937;
        }
        
        .meter-gauge {
            height: 20px;
            background: #e5e7eb;
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .gauge-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s;
        }
        
        .fill-normal { background: #10b981; }
        .fill-warning { background: #f59e0b; }
        .fill-danger { background: #ef4444; }
        
        .chart-container {
            height: 300px;
            margin-top: 30px;
        }
        
        .system-info {
            grid-column: 1 / -1;
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-top: 30px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .info-card {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #8b5cf6;
        }
        
        .info-label {
            font-size: 0.9rem;
            color: #6b7280;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2937;
        }
        
        .alert-box {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .alert-warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            color: #92400e;
        }
        
        .alert-danger {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            color: #991b1b;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: 600;
            z-index: 1000;
        }
        
        .connected { background: #10b981; color: white; }
        .disconnected { background: #ef4444; color: white; }
    </style>
</head>
<body>
    <div class="connection-status disconnected" id="connectionStatus">
        ğŸ”Œ è¿æ¥ä¸­...
    </div>
    
    <div class="container">
        <div class="header">
            <h1>ğŸ­ å·¥ä¸šä»ªè¡¨ç›˜æ™ºèƒ½è¯»æ•°ç³»ç»Ÿ</h1>
            <p>åŸºäºè®¡ç®—æœºè§†è§‰çš„è‡ªåŠ¨åŒ–ç›‘æµ‹è§£å†³æ–¹æ¡ˆ â€¢ å®æ—¶è¯»æ•° â€¢ æ™ºèƒ½é¢„è­¦ â€¢ æ•°æ®å¯è§†åŒ–</p>
        </div>
        
        <div class="main-content">
            <!-- è§†é¢‘ç›‘æ§åŒºåŸŸ -->
            <div class="video-section">
                <h2 class="section-title">
                    <span>ğŸ“¹ å®æ—¶ç›‘æ§ç”»é¢</span>
                    <span class="status-badge status-running" id="streamStatus">ç›‘æ§ä¸­</span>
                </h2>
                
                <div class="video-container">
                    <img id="video-feed" src="" alt="å®æ—¶è§†é¢‘æµ">
                </div>
                
                <div class="control-buttons">
                    <button class="btn btn-primary" onclick="startMonitoring()">
                        â–¶ï¸ å¼€å§‹ç›‘æ§
                    </button>
                    <button class="btn btn-secondary" onclick="stopMonitoring()">
                        â¹ï¸ åœæ­¢ç›‘æ§
                    </button>
                </div>
                
                <div id="alertBox" class="alert-box" style="display: none;">
                    <!-- é¢„è­¦ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
            
            <!-- æ•°æ®å±•ç¤ºåŒºåŸŸ -->
            <div class="data-section">
                <h2 class="section-title">ğŸ“Š ä»ªè¡¨è¯»æ•°</h2>
                
                <div class="meters-grid" id="metersGrid">
                    <!-- ä»ªè¡¨å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    <div class="meter-card">
                        <div class="meter-header">
                            <span class="meter-name">Meter-1</span>
                            <span class="status-badge status-normal">æ­£å¸¸</span>
                        </div>
                        <div class="meter-value">--.--</div>
                        <div class="meter-gauge">
                            <div class="gauge-fill fill-normal" style="width: 0%"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>0</span>
                            <span>50</span>
                            <span>100</span>
                        </div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="readingChart"></canvas>
                </div>
            </div>
            
            <!-- ç³»ç»Ÿä¿¡æ¯ -->
            <div class="system-info">
                <h2 class="section-title">âš™ï¸ ç³»ç»Ÿä¿¡æ¯</h2>
                
                <div class="info-grid" id="systemInfo">
                    <!-- ç³»ç»Ÿä¿¡æ¯å°†é€šè¿‡JavaScriptåŠ¨æ€æ›´æ–° -->
                    <div class="info-card">
                        <div class="info-label">ç³»ç»ŸçŠ¶æ€</div>
                        <div class="info-value" id="systemStatus">è¿è¡Œä¸­</div>
                    </div>
                    
                    <div class="info-card">
                        <div class="info-label">æ£€æµ‹ä»ªè¡¨æ•°</div>
                        <div class="info-value" id="metersCount">2</div>
                    </div>
                    
                    <div class="info-card">
                        <div class="info-label">å¤„ç†å¸§ç‡ (FPS)</div>
                        <div class="info-value" id="processingFPS">5.0</div>
                    </div>
                    
                    <div class="info-card">
                        <div class="info-label">æœ€åæ›´æ–°</div>
                        <div class="info-value" id="lastUpdate">--:--:--</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // å…¨å±€å˜é‡
        let socket = null;
        let isMonitoring = false;
        let chart = null;
        let readingsData = [];
        const maxDataPoints = 20;
        
        // åˆå§‹åŒ–Socketè¿æ¥
        function initSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            
            socket = io.connect(`${protocol}//${host}`, {
                transports: ['websocket'],
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000
            });
            
            // è¿æ¥æˆåŠŸ
            socket.on('connect', function() {
                console.log('âœ… WebSocketè¿æ¥æˆåŠŸ');
                updateConnectionStatus(true);
            });
            
            // è¿æ¥æ–­å¼€
            socket.on('disconnect', function() {
                console.log('âŒ WebSocketè¿æ¥æ–­å¼€');
                updateConnectionStatus(false);
                isMonitoring = false;
            });
            
            // æ¥æ”¶ä»ªè¡¨æ•°æ®
            socket.on('meter_data', function(data) {
                console.log('æ”¶åˆ°ä»ªè¡¨æ•°æ®:', data);
                updateVideoFeed(data.frame);
                updateMetersDisplay(data.readings || []);
                updateSystemInfo(data);
                updateChart(data.readings || []);
                checkAlerts(data.readings || []);
            });
            
            // è¿æ¥å“åº”
            socket.on('connection_response', function(data) {
                console.log('æœåŠ¡å™¨å“åº”:', data);
            });
        }
        
        // æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            if (connected) {
                statusEl.textContent = 'âœ… å·²è¿æ¥';
                statusEl.className = 'connection-status connected';
            } else {
                statusEl.textContent = 'âŒ è¿æ¥æ–­å¼€';
                statusEl.className = 'connection-status disconnected';
            }
        }
        
        // æ›´æ–°è§†é¢‘æµæ˜¾ç¤º
        function updateVideoFeed(frameBase64) {
            const videoEl = document.getElementById('video-feed');
            if (frameBase64) {
                videoEl.src = 'data:image/jpeg;base64,' + frameBase64;
            }
        }
        
        // å¼€å§‹ç›‘æ§
        function startMonitoring() {
            if (!socket || !socket.connected) {
                alert('è¯·å…ˆå»ºç«‹WebSocketè¿æ¥');
                return;
            }
            
            if (!isMonitoring) {
                socket.emit('start_monitoring');
                isMonitoring = true;
                document.getElementById('streamStatus').textContent = 'ç›‘æ§ä¸­';
                document.getElementById('streamStatus').className = 'status-badge status-running';
                console.log('å¼€å§‹ç›‘æ§ä»ªè¡¨...');
            }
        }
        
        // åœæ­¢ç›‘æ§
        function stopMonitoring() {
            isMonitoring = false;
            document.getElementById('streamStatus').textContent = 'å·²åœæ­¢';
            document.getElementById('streamStatus').className = 'status-badge status-danger';
            console.log('åœæ­¢ç›‘æ§ä»ªè¡¨...');
            
            // æ¸…ç©ºè§†é¢‘æµ
            document.getElementById('video-feed').src = '';
        }
        
        // æ›´æ–°ä»ªè¡¨æ˜¾ç¤º
        function updateMetersDisplay(readings) {
            const gridEl = document.getElementById('metersGrid');
            
            // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºé»˜è®¤çŠ¶æ€
            if (!readings || readings.length === 0) {
                gridEl.innerHTML = `
                    <div class="meter-card">
                        <div class="meter-header">
                            <span class="meter-name">ç­‰å¾…æ•°æ®...</span>
                            <span class="status-badge status-warning">ç­‰å¾…</span>
                        </div>
                        <div class="meter-value">--.--</div>
                        <div class="meter-gauge">
                            <div class="gauge-fill fill-warning" style="width: 50%"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>0</span>
                            <span>50</span>
                            <span>100</span>
                        </div>
                    </div>
                `;
                return;
            }
            
            // åŠ¨æ€ç”Ÿæˆä»ªè¡¨å¡ç‰‡
            let html = '';
            readings.forEach((meter, index) => {
                const percentage = (meter.value / 100) * 100;
                const statusClass = `status-${meter.status || 'normal'}`;
                const fillClass = `fill-${meter.status || 'normal'}`;
                const statusText = {
                    'normal': 'æ­£å¸¸',
                    'warning': 'è­¦å‘Š',
                    'danger': 'å±é™©'
                }[meter.status] || 'æ­£å¸¸';
                
                html += `
                    <div class="meter-card">
                        <div class="meter-header">
                            <span class="meter-name">ä»ªè¡¨-${index + 1}</span>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <div class="meter-value">${meter.value.toFixed(2)}</div>
                        <div class="meter-gauge">
                            <div class="gauge-fill ${fillClass}" style="width: ${percentage}%"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>0</span>
                            <span>50</span>
                            <span>100</span>
                        </div>
                        <div style="margin-top: 10px; font-size: 0.9rem; color: #6b7280;">
                            è§’åº¦: ${meter.angle || 0}Â° | ç½®ä¿¡åº¦: ${((meter.confidence || 0) * 100).toFixed(1)}%
                        </div>
                    </div>
                `;
            });
            
            gridEl.innerHTML = html;
        }
        
        // æ›´æ–°ç³»ç»Ÿä¿¡æ¯
        function updateSystemInfo(data) {
            document.getElementById('systemStatus').textContent = 'è¿è¡Œä¸­';
            document.getElementById('metersCount').textContent = data.readings?.length || 0;
            document.getElementById('lastUpdate').textContent = data.timestamp || '--:--:--';
            
            // æ›´æ–°FPSï¼ˆç®€å•è®¡ç®—ï¼‰
            if (!window.lastUpdateTime) window.lastUpdateTime = Date.now();
            const now = Date.now();
            const fps = 1000 / (now - window.lastUpdateTime);
            window.lastUpdateTime = now;
            document.getElementById('processingFPS').textContent = fps.toFixed(1);
        }
        
        // åˆå§‹åŒ–å›¾è¡¨
        function initChart() {
            const ctx = document.getElementById('readingChart').getContext('2d');
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'ä»ªè¡¨-1 è¯»æ•°',
                            data: [],
                            borderColor: '#4f46e5',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'ä»ªè¡¨-2 è¯»æ•°',
                            data: [],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'è¯»æ•° (%)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¶é—´'
                            }
                        }
                    }
                }
            });
        }
        
        // æ›´æ–°å›¾è¡¨æ•°æ®
        function updateChart(readings) {
            if (!chart) return;
            
            const now = new Date();
            const timeLabel = `${now.getHours()}:${now.getMinutes()}:${now.getSeconds()}`;
            
            // æ›´æ–°æ ‡ç­¾
            if (chart.data.labels.length >= maxDataPoints) {
                chart.data.labels.shift();
            }
            chart.data.labels.push(timeLabel);
            
            // æ›´æ–°æ•°æ®
            readings.forEach((meter, index) => {
                if (chart.data.datasets[index]) {
                    if (chart.data.datasets[index].data.length >= maxDataPoints) {
                        chart.data.datasets[index].data.shift();
                    }
                    chart.data.datasets[index].data.push(meter.value);
                }
            });
            
            chart.update();
        }
        
        // æ£€æŸ¥é¢„è­¦
        function checkAlerts(readings) {
            const alertBox = document.getElementById('alertBox');
            let hasAlert = false;
            let alertHtml = '';
            
            readings.forEach((meter, index) => {
                if (meter.status === 'warning') {
                    hasAlert = true;
                    alertHtml += `
                        <div style="margin-bottom: 5px;">
                            âš ï¸ <strong>ä»ªè¡¨-${index + 1}</strong> è¯»æ•° ${meter.value.toFixed(2)} è¶…è¿‡è­¦æˆ’çº¿ (80)ï¼
                        </div>
                    `;
                }
                if (meter.status === 'danger') {
                    hasAlert = true;
                    alertHtml += `
                        <div style="margin-bottom: 5px;">
                            ğŸš¨ <strong>ä»ªè¡¨-${index + 1}</strong> è¯»æ•° ${meter.value.toFixed(2)} è¶…è¿‡å±é™©çº¿ (90)ï¼è¯·ç«‹å³å¤„ç†ï¼
                        </div>
                    `;
                }
            });
            
            if (hasAlert) {
                alertBox.style.display = 'block';
                alertBox.innerHTML = alertHtml;
                alertBox.className = readings.some(m => m.status === 'danger') 
                    ? 'alert-box alert-danger' 
                    : 'alert-box alert-warning';
                
                // å¦‚æœå­˜åœ¨å±é™©çŠ¶æ€ï¼Œæ’­æ”¾è­¦å‘ŠéŸ³
                if (readings.some(m => m.status === 'danger')) {
                    playAlertSound();
                }
            } else {
                alertBox.style.display = 'none';
            }
        }
        
        // æ’­æ”¾è­¦å‘ŠéŸ³
        function playAlertSound() {
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ');
                audio.play();
            } catch (e) {
                console.log('è­¦å‘ŠéŸ³æ’­æ”¾å¤±è´¥:', e);
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.onload = function() {
            console.log('ğŸ­ å·¥ä¸šä»ªè¡¨è¯»æ•°ç³»ç»Ÿå‰ç«¯å¯åŠ¨');
            initSocket();
            initChart();
            
            // 3ç§’åè‡ªåŠ¨å¼€å§‹ç›‘æ§ï¼ˆå¯é€‰ï¼‰
            setTimeout(() => {
                if (socket && socket.connected) {
                    startMonitoring();
                }
            }, 3000);
        };
        
        // é¡µé¢å…³é—­å‰æ¸…ç†
        window.addEventListener('beforeunload', function() {
            if (socket) {
                socket.disconnect();
            }
        });
    </script>
</body>
</html>
